---
title: "03_figures"
author: "Valerie Milici"
date: "7/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages used}
library(tidyverse) #always
library(ggplot2) #for plotting
library(patchwork) #joins plots nicely
library(sjPlot) #forest plots
library(ggthemes)
```

## The effect of treatment on Growth
```{r RGR Forest Plot}
RGR.forest <- plot_model(RGR.mod,
                         rm.terms = c("log_Init_Height_mm",
                                               "as.factor(Cohort)2"),
                        vline.color = "grey",
                         title = "",
                       axis.labels = c("Sterile Soil x Wet", "Heterospecific Soil x Wet",
                                    "Wet Treatment", 
                                      "Heterospecific Soil",
                                      "Conspecific Soil"),
                        axis.title = "Treatment effects on RGR log(mm/mm/mo)",
                        show.values = T) +
                      theme_classic() +
                      scale_y_continuous(limits = c(-0.05, 0.06))
summary(RGR.mod)
RGR.forest
```

## The effect of treatment on survival
```{r Survival Forest Plot}
surv.forest <- plot_model(surv.ts, rm.terms = c("log_htprevcensus_s",
                                                "as.factor(Cohort)2"),
                          order.terms = c(2,1,3,5,4),
                          vline.color = "grey",
                          title = "",
                          axis.title = "Log Mortality Risk Ratios",
                          show.values = T) +
                theme_bw() +
                theme(axis.text.y = element_blank(),
                 axis.ticks.y = element_blank())

surv.forest

```
```{r combine forest plots}
perf.fig <- RGR.forest+surv.forest+ plot_annotation(tag_levels = "A")

perf.fig

ggsave("figures/perf.fig.jpeg", height = 4, width = 6, units = "in")


```

```{r RGR Model Figure}

preddat <- expand.grid(soil = c("conspecific", "heterospecific", "control"),
                         Treatment = c("D", "W"),
                       log_Init_Height_mm = 4.09)

preddat$soil <- factor(preddat$soil,
                          levels = c("control", "conspecific", "heterospecific"))

#variance covariance matrix of the model without nuisance variables
mod.vcov <- vcov(RGR.mod)[-c(1,6),][,-c(1,6)]

#create the design matrix
Xmat <- model.matrix(~soil*Treatment + log_Init_Height_mm , data = preddat)
XB <- model.matrix(~soil*Treatment + log_Init_Height_mm , data = preddat)
Xmat<- Xmat[-3,][,-1] #remove intercept

XBeta <- XB %*% fixef(RGR.mod)[-6]

#matrix algebra between the two
est.se <- data.frame(se = sqrt(diag(Xmat %*% mod.vcov %*% t(Xmat))))



dry.est <- data.frame(var = c("conspecific" ,"heterospecific"),
                      est = XBeta[c(1:2),],
                      trt = c("D", "D"),
                      se = est.se[c(1:2),])
wet.est <- data.frame(var = c("conspecific" ,"heterospecific"),
                      est = XBeta[c(4:5),],
                      trt = c("W", "W"),
                      se = est.se[c(3:4),])


dry.est <- dry.est %>% mutate(lwr = est - se,
                              upr = est + se,
                              dH = exp((est*6) + log(60)) - 60)

wet.est <- wet.est %>% mutate(lwr = est - se,
                              upr = est + se)

exp((0.101*4) + log(60)) - 60

#Dry Treatment -----------------------------------------------------------------
dryplot <- ggplot(dry.est, aes(trt, est, col = var, group = var)) + 
  geom_pointrange(aes(ymin = lwr, ymax = upr),
                position = position_dodge(width = 0.4)) +
  geom_hline(yintercept = XBeta[3,1], color = " dark grey") +
  labs(x = "",
       y = "RGR (mm/mm/mo)",
       col = "") +
  scale_x_discrete(labels = c( "D" = "50% Saturation"),
                   limits = c("D")) +
  scale_fill_viridis_d(option = "viridis", begin = 0.1, end = 0.6) +
  scale_color_viridis_d(option = "viridis", begin = 0.1, end = 0.6) +
  theme_classic()+
  ylim(0.415, 0.460) +
  theme(legend.position = 'bottom') +
  theme(axis.text = element_text(size = 16)) +
  theme(axis.title = element_text(size = 20)) +
  theme(legend.text = element_text(size = 16))


ggsave("04_figures/dryPlot.jpeg", width = 2, height = 3, units = "in")

#Wet treatment -----------------------------------------------------------------
wetplot <- ggplot(wet.est, aes(trt, est, col = var, group = var)) + 
  geom_pointrange(aes(ymin = lwr, ymax = upr),
                position = position_dodge(width = 0.4)) +
  geom_hline(yintercept = XBeta[6,1], color = " dark grey") +
  labs(x = "",
       y = "",
       col = "") +
  scale_x_discrete(labels = c( "W" = "100% Saturation"),
                   limits = c("W")) +
  scale_fill_viridis_d(option = "viridis", begin = 0.1, end = 0.6) +
  scale_color_viridis_d(option = "viridis", begin = 0.1, end = 0.6) +
  theme_classic()+
  ylim(0.415, 0.460) +
  theme(axis.ticks.y = element_blank())+
  theme(axis.text.y = element_blank()) +
  theme(legend.position = 'bottom') +
   theme(axis.text = element_text(size = 16)) +
  theme(axis.title = element_text(size = 20)) +
  theme(legend.text = element_text(size = 16))


ggsave("04_figures/wetPlot.jpeg", width = 2, height = 3, units = "in")

# Patchwork the plots together -------------------------------------------------
RGRPlot2 <-  dryplot + wetplot + 
   plot_annotation(caption = "Soil Moisture Treatment", 
  theme = theme(plot.caption = element_text(size = 16, hjust = 0.63))) +
    plot_layout(guides = "collect") & theme(legend.position = "bottom",) 

 ggsave("04_figures/RGRPlot2.jpeg", width = 4, height = 3, units = "in") 
 
 RGRPlot2
   
```


```{r Height Model Figure}
pred_height <- data.frame(cbind(Init_Height_mm <- c(60,60,60,60,60,60), duration.mo <- c(5,5,5,5,5,5), 
                       W <- c(5, 5, 0, 0,5,0), het <- c(5,0,5,0,0,0), cntrl <- c(0,5,0,5,0,0),
                       Whet <- c(5,0,0,0,0,0), Wcntrl <- c(0,5,0,0,0,0)))
names(pred_height)[1:7] <- c("Init_Height", "duration.mo", "W", "het", "cntrl", "Whet", "Wcntrl")

pred_height$preds <- predict(height.mod, newdata = pred_height, re.form = ~0)



load("BootOutput/height.mod.boot")

pred_height<- data.frame(pred_height, confint(height.mod.boot))

names(pred_height)[9:10]<- c("lwr", "upr")

#add meaningful columns/rows

pred_height <- mutate(pred_height, Treatment = ifelse(W == 5, "W", "D"))

pred_height <- mutate(pred_height, soil = case_when(het == 5 ~ "heterospecific"
                                                    ,cntrl == 5 ~ "control"
                                                    ,TRUE ~ "conspecific"))
pred_height <- mutate(pred_height, fin.ht = exp(preds))
pred_height <- mutate(pred_height, ht.change = fin.ht - Init_Height_mm)
pred_height <- mutate(pred_height, upr.ch = exp(upr) - 60)
pred_height <- mutate(pred_height, lwr.ch = exp(lwr) - 60)

pred_height <- mutate(pred_height, soil = fct_relevel(soil,
                                                      "conspecific",
                                                      "heterospecific",
                                                      "control"))
                                              
```



```{r make a graph}

HtPlot <- ggplot(pred_height, aes(Treatment, ht.change,
                        col = soil,
                        group = soil)) + 
  geom_pointrange(aes(ymin = lwr.ch, ymax = upr.ch),
                position = position_dodge(width = 0.4)) +
 
  
  labs(x = "Soil Moisture Treatment",
       y = "Change in Height (mm)",
       col = "") +
  scale_x_discrete(labels = c("W" = "100% Saturation", "D" = "50% Saturation"),
                   limits = c("D", "W")) +
  scale_fill_viridis_d(option = "viridis") +
  scale_color_viridis_d(option = "viridis") +
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave("figures/HtPlot.jpeg", width = 4, height = 3, units = "in")

HtPlot

```

```{r biomass allocation fig prep}
pred_biorat <- expand.grid(Treatment = c("D", "W"),
                         soil = c("conspecific", "heterospecific", "control"),
                         duration = 142,
                         Init_Height = 6)

pred_biorat$preds <- predict(bioratio.mod, newdata = pred_biorat, re.form = ~0)

#CI 
 
brat.fun <- function(.){
  preddat <- expand.grid(Treatment = c("D", "W"),
                         soil = c("conspecific", "heterospecific", "control"),
                         duration = 142,
                         Init_Height = 6)
  predict(., newdata = preddat, re.form = ~0)
}

brat.mod.boot <- bootMer(bioratio.mod, nsim = 1000, FUN = brat.fun,
                         parallel = "snow", ncpus = detectCores(),
                         cl =cl)
                         


pred_biorat <- data.frame(pred_biorat, confint(brat.mod.boot))

names(pred_biorat)[6:7] <- c("lwr", "upr")
```

```{r make a graph}

bratPlot <- ggplot(pred_biorat, aes(Treatment, preds,
                        col = soil,
                        group = soil)) + 
  geom_pointrange(aes(ymin = lwr, ymax = upr),
                position = position_dodge(width = 0.4)) +
 
  
  labs(x = "Soil Moisture Treatment",
       y = "Shoot:Root Ratio",
       col = "") +
  scale_x_discrete(labels = c("W" = "100% Saturation", "D" = "50% Saturation"),
                   limits = c("D", "W")) +
  scale_fill_viridis_d(option = "viridis") +
  scale_color_viridis_d(option = "viridis") +
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave("figures/bratPlot.jpeg", width = 4, height = 3, units = "in")

bratPlot

```
```{r biomass2 allocation fig prep}
pred_biorat2 <- expand.grid(Treatment = c("D", "W"),
                         Wanted = c("dead", "alive"),
                         duration = 142,
                         Init_Height = 6)

pred_biorat2$preds <- predict(biorat2, newdata = pred_biorat2, re.form = ~0)

#CI Method 1- needs help
#RGR_Cis <- predict(RGR.mod, newdata = pred_RGR, re.form =~0, #this gives me the predicted means.
                #   interval = "confidence", level = 0.95)
#CI Method 2 - too aggressive?
brat2.fun <- function(.){
  preddat <- expand.grid(Treatment = c("D", "W"),
                         Wanted = c("dead", "alive"),
                         duration = 142,
                         Init_Height = 6)
  predict(., newdata = preddat, re.form = ~0)
}

brat2.boot <- bootMer(biorat2, nsim = 1000, FUN = brat2.fun,
                         parallel = "snow", ncpus = detectCores(),
                         cl =cl)
                         


pred_biorat2 <- data.frame(pred_biorat2, confint(brat2.boot))

names(pred_biorat2)[6:7] <- c("lwr", "upr")
```

```{r make a graph}

brat2Plot <- ggplot(pred_biorat2, aes(Treatment, preds,
                        col = Wanted,
                        group = Wanted)) + 
  geom_pointrange(aes(ymin = lwr, ymax = upr),
                position = position_dodge(width = 0.4)) +
 
  
  labs(x = "Soil Moisture Treatment",
       y = "Shoot:Root Ratio",
       col = "") +
  scale_x_discrete(labels = c("W" = "100% Saturation", "D" = "50% Saturation"),
                   limits = c("D", "W")) +
  scale_fill_viridis_d(option = "viridis", begin = 0.2, end = 0.8) +
  scale_color_viridis_d(option = "viridis", begin = 0.2, end = 0.8) +
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave("figures/brat2Plot.jpeg", width = 4, height = 3, units = "in")

brat2Plot

```


```{r Survival Model Figure Prep}

pred_surv <- expand.grid(Treatment = c("W", "D"),
                         soil = c("conspecific", "heterospecific", "control"),
                         htprevcensus = 6)

pred_surv$preds <- predict(surv.ts, newdata = pred_surv, re.form = ~0)
                         
load("BootOutput/surv.mod.boot")

pred_surv <- data.frame(pred_surv, confint(surv.mod.boot))

names(pred_surv)[5:6] <- c("lwr", "upr")
```

```{r Survival Model Figure}
SurvPlot <- ggplot(pred_surv, aes(Treatment, plogis(preds),
                        col = soil,
                        group = soil)) + 
  geom_pointrange(aes(ymin = plogis(lwr), ymax = plogis(upr)),
                  position = position_dodge(width = 0.4)) +
  labs(x = "Soil Moisture Treatment",
       y = "Daily Probability of Mortality",
       col = "") +
  scale_x_discrete(labels = c("W" = "100% Saturation", "D" = "50% Saturation"),
                   limits = c("D", "W")) +
  scale_fill_viridis_d(option = "viridis") +
  scale_color_viridis_d(option = "viridis") +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave("figures/SurvPlot.jpeg", width = 4, height = 3, units = "in")


```
Why is survival probability so low??? OMG because I had to switch my 0's and 1's for the cloglog link! This is NOT probability of survival but probability of mortality. This also means that probability of survival is super high. how is it possible when 30% of my seedlings died? Is this the probability of death from one census to the other? I think it might be... the DAILY probability of death. 
